<VirtualHost *:80>
    ServerAdmin admin@yourdomain.com
    DocumentRoot "/var/www/nextcloud"
    ServerName nextcloud
    
    # Enable HTTP/2 if module is active
    Protocols h2 http/1.1

    <Directory "/var/www/nextcloud/">
        Options MultiViews FollowSymlinks
        AllowOverride All
        Require all granted
        
        # Security optimization to avoid direct access to sensitive data
        <IfModule mod_dav.c>
            Dav off
        </IfModule>
    </Directory>

    # CRITICAL CONFIGURATION: Connect Apache to PHP-FPM 8.3 via Socket
    # This is required because the script uses php8.3-fpm instead of mod_php
    <FilesMatch "\.php$">
        SetHandler "proxy:unix:/run/php/php8.3-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Basic Security Headers (Nextcloud .htaccess handles most, 
    # but it is good practice to enforce in Vhost if mod_headers is active)
    <IfModule mod_headers.c>
        Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set X-Robots-Tag "none"
        Header always set X-Download-Options "noopen"
        Header always set X-Permitted-Cross-Domain-Policies "none"
        Header always set Referrer-Policy "no-referrer"
    </IfModule>
    # Optimized Logs
    ErrorLog ${APACHE_LOG_DIR}/nextcloud_error.log
    CustomLog ${APACHE_LOG_DIR}/nextcloud_access.log combined
</VirtualHost>
